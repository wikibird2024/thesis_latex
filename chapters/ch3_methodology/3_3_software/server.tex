\subsection{M√°y ch·ªß: Qu·∫£n l√Ω v√† X·ª≠ l√Ω D·ªØ li·ªáu Trung t√¢m}
\label{sec:server_overview}

M√°y ch·ªß Python ƒë√≥ng vai tr√≤ trung t√¢m x·ª≠ l√Ω, t√≠ch h·ª£p d·ªØ li·ªáu t·ª´ hai ngu·ªìn ƒë·ªôc l·∫≠p:
\begin{enumerate}
    \item \textbf{ESP32 (c·∫£m bi·∫øn chuy·ªÉn ƒë·ªông)}: Tri·ªÉn khai t·∫°i hi·ªán tr∆∞·ªùng, g·ª≠i d·ªØ li·ªáu tr·∫°ng th√°i t√© ng√£ v√† t·ªça ƒë·ªô GPS qua giao th·ª©c MQTT.
    \item \textbf{Camera IP (x·ª≠ l√Ω th·ªã gi√°c)}: Ch·∫°y tr√™n m√°y ch·ªß ho·∫∑c m√°y t√≠nh chuy√™n d·ª•ng, th·ª±c hi·ªán ph√°t hi·ªán ng∆∞·ªùi, theo d√µi ƒë·ªëi t∆∞·ª£ng, v√† ∆∞·ªõc l∆∞·ª£ng t∆∞ th·∫ø b·∫±ng m√¥ h√¨nh AI.
\end{enumerate}

M√°y ch·ªß ƒë·ªìng b·ªô h√≥a v√† t√≠ch h·ª£p d·ªØ li·ªáu t·ª´ hai ngu·ªìn n√†y ƒë·ªÉ ƒë∆∞a ra quy·∫øt ƒë·ªãnh ph√°t hi·ªán t√© ng√£ ch√≠nh x√°c, k√≠ch ho·∫°t c·∫£nh b√°o, v√† ghi nh·∫≠n s·ª± ki·ªán v√†o c∆° s·ªü d·ªØ li·ªáu.

\subsubsection{Ki·∫øn tr√∫c H·ªá th·ªëng}
\label{subsubsec:system_overview}

H·ªá th·ªëng ƒë∆∞·ª£c thi·∫øt k·∫ø theo m√¥ h√¨nh ph√¢n t·∫ßng v√† m√¥-ƒëun h√≥a, nh∆∞ minh h·ªça trong H√¨nh~\ref{fig:system_architecture}, bao g·ªìm:
\begin{itemize}
    \item \textbf{L·ªõp thu nh·∫≠n d·ªØ li·ªáu}:
    \begin{itemize}
        \item \texttt{comm/}: Nh·∫≠n d·ªØ li·ªáu t·ª´ ESP32 qua MQTT, qu·∫£n l√Ω Telegram Bot v√† AMI ƒë·ªÉ g·ª≠i c·∫£nh b√°o.
        \item \texttt{detection/}: X·ª≠ l√Ω khung h√¨nh t·ª´ camera IP, th·ª±c hi·ªán ph√°t hi·ªán ng∆∞·ªùi, theo d√µi, v√† ∆∞·ªõc l∆∞·ª£ng t∆∞ th·∫ø.
    \end{itemize}
    \item \textbf{L·ªõp x·ª≠ l√Ω t·ªïng h·ª£p}: \texttt{fall/} v√† \texttt{processing/} t√≠ch h·ª£p d·ªØ li·ªáu t·ª´ ESP32 v√† camera, s·ª≠ d·ª•ng \texttt{DetectionProcessor} ƒë·ªÉ ƒë·ªìng b·ªô v√† ra quy·∫øt ƒë·ªãnh t√© ng√£.
    \item \textbf{L·ªõp ƒë·∫ßu ra}: \texttt{database/} ghi s·ª± ki·ªán v√†o \texttt{fall\_events.db}, \texttt{comm/} g·ª≠i c·∫£nh b√°o qua Telegram v√† AMI.
\end{itemize}

\begin{table}[H]
\centering
\caption{C·∫•u tr√∫c c√°c m√¥-ƒëun m√°y ch·ªß v√† vai tr√≤}
\label{tab:server_modules}
\begin{tabular}{|l|l|p{7cm}|}
\hline
\textbf{Module} & \textbf{L·ªõp (Layer)} & \textbf{Vai tr√≤ v√† ch·ª©c nƒÉng} \\
\hline
\texttt{comm/} & Input/Output & Nh·∫≠n d·ªØ li·ªáu MQTT, qu·∫£n l√Ω Telegram Bot v√† AMI \\
\hline
\texttt{detection/} & Input & X·ª≠ l√Ω video, ph√°t hi·ªán ng∆∞·ªùi, theo d√µi, ∆∞·ªõc l∆∞·ª£ng t∆∞ th·∫ø \\
\hline
\texttt{fall/} & Processing & Thu·∫≠t to√°n ph√°t hi·ªán t√© ng√£ t·ª´ ESP32 v√† camera \\
\hline
\texttt{processing/} & Processing & \texttt{DetectionProcessor} ƒë·ªìng b·ªô v√† t√≠ch h·ª£p d·ªØ li·ªáu \\
\hline
\texttt{database/} & Storage & Ghi s·ª± ki·ªán v√†o \texttt{fall\_events.db} \\
\hline
\texttt{config/} & Support & C·∫•u h√¨nh h·ªá th·ªëng (MQTT, AI, database, AMI, Telegram) \\
\hline
\texttt{models/} & Support & L∆∞u tr·ªØ m√¥ h√¨nh YOLOv8n v√† tr·ªçng s·ªë \\
\hline
\texttt{utils/} & Support & C√¥ng c·ª• v·∫Ω skeleton, h·ªó tr·ª£ debug \\
\hline
\texttt{tests/} & Testing & Script ki·ªÉm tra logic ph√°t hi·ªán t√© ng√£ \\
\hline
\texttt{main.py} & Entry point & ƒêi·ªÅu ph·ªëi d·ªØ li·ªáu v√† ra quy·∫øt ƒë·ªãnh \\
\hline
\end{tabular}
\end{table}

\subsubsection{C·∫•u tr√∫c Th∆∞ m·ª•c D·ª± √°n}
\label{subsubsec:project_structure}

C·∫•u tr√∫c th∆∞ m·ª•c d·ª± √°n ƒë∆∞·ª£c t·ªï ch·ª©c ƒë·ªÉ ph·∫£n √°nh m√¥-ƒëun h√≥a c·ªßa h·ªá th·ªëng:

\begin{minted}[fontsize=\footnotesize, breaklines, frame=single, linenos]{text}
intergrate_fall/
‚îú‚îÄ‚îÄ comm/
‚îÇ   ‚îú‚îÄ‚îÄ ami_trigger.py
‚îÇ   ‚îú‚îÄ‚îÄ mqtt_client.py
‚îÇ   ‚îî‚îÄ‚îÄ telegram_bot.py
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ config.py
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îî‚îÄ‚îÄ database_manager.py
‚îú‚îÄ‚îÄ detection/
‚îÇ   ‚îú‚îÄ‚îÄ human_detector.py
‚îÇ   ‚îú‚îÄ‚îÄ person_tracker.py
‚îÇ   ‚îî‚îÄ‚îÄ skeleton_tracker.py
‚îú‚îÄ‚îÄ fall/
‚îÇ   ‚îî‚îÄ‚îÄ fall_detector.py
‚îú‚îÄ‚îÄ processing/
‚îÇ   ‚îî‚îÄ‚îÄ detection_processor.py
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ draw_utils.py
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ yolov8n.pt
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ test_fall.py
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ fall_events.db
\end{minted}

\subsubsection{Lu·ªìng X·ª≠ l√Ω M√°y ch·ªß}
\label{subsubsec:server_flow}

H·ªá th·ªëng x·ª≠ l√Ω d·ªØ li·ªáu theo lu·ªìng sau (xem H√¨nh~\ref{fig:server_flow}):
\begin{enumerate}
    \item Thu nh·∫≠n d·ªØ li·ªáu t·ª´ ESP32 (qua MQTT) v√† camera IP (qua x·ª≠ l√Ω th·ªã gi√°c).
    \item \texttt{DetectionProcessor} ƒë·ªìng b·ªô v√† t√≠ch h·ª£p d·ªØ li·ªáu, x√°c ƒë·ªãnh tr·∫°ng th√°i t√© ng√£.
    \item Ghi s·ª± ki·ªán t√© ng√£ v√†o \texttt{fall\_events.db} v√† g·ª≠i c·∫£nh b√°o qua AMI/Telegram.
\end{enumerate}

\begin{figure}[H]
\centering
\includegraphics[width=0.85\textwidth]{figures/server_flow.pdf}
\caption{Lu·ªìng d·ªØ li·ªáu v√† x·ª≠ l√Ω tr√™n m√°y ch·ªß: t√≠ch h·ª£p ESP32 v√† Camera IP qua \texttt{DetectionProcessor}.}
\label{fig:server_flow}
\end{figure}

\begin{minted}[linenos, frame=lines, fontsize=\small, bgcolor=lightgray, breaklines]{python}
while system_is_running:
    frame = camera_thread.get_latest_frame()
    sensor_data = mqtt_thread.get_latest_data()
    
    detections = human_detector.process(frame)
    poses = pose_estimator.process(detections)
    
    for person_id, (box, landmarks) in enumerate(detections):
        await processor.handle_camera_data(frame, person_id, box, landmarks)
    
    if sensor_data:
        await processor.handle_mqtt_data(sensor_data)
\end{minted}

\subsubsection{K·∫øt h·ª£p D·ªØ li·ªáu ƒêa ph∆∞∆°ng th·ª©c}
\label{subsubsec:multi_input_fusion}

\texttt{DetectionProcessor} t√≠ch h·ª£p d·ªØ li·ªáu t·ª´ ESP32 (MQTT JSON) v√† camera IP (AI), th·ª±c hi·ªán:
\begin{itemize}
    \item X√°c th·ª±c d·ªØ li·ªáu ESP32: ki·ªÉm tra \texttt{device\_id}, \texttt{fall\_detected}, v√† t·ªça ƒë·ªô GPS (n·∫øu c√≥).
    \item X·ª≠ l√Ω d·ªØ li·ªáu camera: ph√°t hi·ªán ng∆∞·ªùi, ∆∞·ªõc l∆∞·ª£ng t∆∞ th·∫ø, x√°c ƒë·ªãnh tr·∫°ng th√°i t√© ng√£.
    \item ƒê·ªìng b·ªô d·ªØ li·ªáu d·ª±a tr√™n timestamp v√† ki·ªÉm tra cooldown (5 ph√∫t) ƒë·ªÉ tr√°nh g·ª≠i c·∫£nh b√°o l·∫∑p l·∫°i.
    \item G·ª≠i c·∫£nh b√°o qua AMI v√† Telegram, v·ªõi c∆° ch·∫ø th·ª≠ l·∫°i khi g·∫∑p l·ªói m·∫°ng.
\end{itemize}

\begin{minted}[linenos, frame=lines, fontsize=\small, bgcolor=lightgray, breaklines]{python}
async def handle_camera_data(self, frame: Optional[np.ndarray], person_id: int, box: list, landmarks: list):
    """Process camera frame, detect falls, and send alerts if needed."""
    entity_id = f"camera_person_{person_id}"
    detector = self._get_or_create_detector(entity_id)
    is_fall = detector.detect_fall(landmarks)

    if frame is not None and isinstance(frame, np.ndarray) and frame.size > 0:
        status = "fall" if is_fall else "normal"
        draw_person(frame, box, landmarks, entity_id, status)

    if is_fall and self._can_alert(entity_id):
        fall_event = self._create_fall_event("camera", entity_id, latitude=0, longitude=0, has_gps_fix=False)
        fall_id = await self._insert_fall_event_with_retry(fall_event)
        if fall_id is None:
            return

        alert_msg = f"‚ö†Ô∏è Fall detected by camera for {entity_id}. Event ID: {fall_id}"
        logger.info(alert_msg)
        await self._send_alerts(alert_msg, frame)
        self._update_last_alert(entity_id)
\end{minted}

\begin{minted}[linenos, frame=lines, fontsize=\small, bgcolor=lightgray, breaklines]{python}
async def handle_mqtt_data(self, mqtt_msg: Any, topic: str = None) -> None:
    """Process MQTT data from ESP32, validate, and handle fall alerts."""
    if not isinstance(mqtt_msg, dict):
        try:
            mqtt_msg = json.loads(mqtt_msg)
        except (json.JSONDecodeError, TypeError):
            logger.error("[MQTT] Failed to parse JSON payload")
            return

    device_id = mqtt_msg.get("device_id")
    fall_detected = mqtt_msg.get("fall_detected")
    if not device_id or fall_detected is not True:
        return

    latitude = mqtt_msg.get("latitude")
    longitude = mqtt_msg.get("longitude")
    has_gps_fix = mqtt_msg.get("has_gps_fix", False)

    if self._can_alert(device_id):
        fall_event = self._create_fall_event("esp32", device_id, latitude, longitude, has_gps_fix)
        fall_id = await self._insert_fall_event_with_retry(fall_event)
        if fall_id is None:
            return

        gps_info = f"{latitude}, {longitude}" if has_gps_fix and latitude is not None else "Unknown"
        alert_msg = f"üö® Fall detected by device {device_id} at GPS: {gps_info}. Event ID: {fall_id}"
        await self._send_alerts(alert_msg, None)
        self._update_last_alert(device_id)
\end{minted}

\subsubsection{Thu·∫≠t to√°n Ph√°t hi·ªán T√© ng√£}
\label{subsubsec:fall_detection_algorithm}

Thu·∫≠t to√°n trong \texttt{FallDetector} ph√¢n t√≠ch chuy·ªÉn ƒë·ªông v√† g√≥c th√¢n ng∆∞·ªùi d·ª±a tr√™n landmarks t·ª´ camera v√† d·ªØ li·ªáu c·∫£m bi·∫øn t·ª´ ESP32, nh∆∞ minh h·ªça trong H√¨nh~\ref{fig:python_fall_diagram}:
\begin{itemize}
    \item \textbf{Ki·ªÉm tra landmarks:} X√°c th·ª±c d·ªØ li·ªáu, reset b·ªô ƒë·∫øm n·∫øu kh√¥ng h·ª£p l·ªá.
    \item \textbf{T√≠nh to√°n g√≥c v√† v·∫≠n t·ªëc:} D·ª±a tr√™n vai v√† h√¥ng, t√≠nh g√≥c th√¢n ng∆∞·ªùi so v·ªõi ph∆∞∆°ng th·∫≥ng ƒë·ª©ng v√† v·∫≠n t·ªëc chuy·ªÉn ƒë·ªông.
    \item \textbf{X√°c ƒë·ªãnh tr·∫°ng th√°i:}
    \begin{itemize}
        \item \textit{Falling}: G√≥c th√¢n ng∆∞·ªùi v∆∞·ª£t ng∆∞·ª°ng v√† v·∫≠n t·ªëc cao.
        \item \textit{Lying}: G√≥c th√¢n ng∆∞·ªùi g·∫ßn ngang trong th·ªùi gian nh·∫•t ƒë·ªãnh.
    \end{itemize}
    \item \textbf{Ra quy·∫øt ƒë·ªãnh:} N·∫øu tr·∫°ng th√°i \textit{Falling} ho·∫∑c \textit{Lying} k√©o d√†i qu√° ng∆∞·ª°ng th·ªùi gian, k·∫øt lu·∫≠n t√© ng√£ v√† reset b·ªô ƒë·∫øm.
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=0.9\textwidth]{figures/python_fall_diagram.pdf}
\caption{L∆∞u ƒë·ªì thu·∫≠t to√°n ph√°t hi·ªán t√© ng√£ trong Python.}
\label{fig:python_fall_diagram}
\end{figure}

\subsubsection{L∆∞u tr·ªØ v√† C·∫£nh b√°o}
\label{subsubsec:data_storage_alerts}

S·ª± ki·ªán t√© ng√£ ƒë∆∞·ª£c ghi v√†o \texttt{fall\_events.db}:

\begin{minted}[linenos, frame=lines, fontsize=\small, bgcolor=lightgray, breaklines]{sql}
CREATE TABLE fall_events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    source TEXT NOT NULL,
    entity_id TEXT NOT NULL,
    fall_detected BOOLEAN NOT NULL,
    latitude REAL,
    longitude REAL,
    has_gps_fix BOOLEAN,
    alert_status INTEGER DEFAULT 0
);
\end{minted}
