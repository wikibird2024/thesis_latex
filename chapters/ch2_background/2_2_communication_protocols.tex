\section{Các Giao Thức Truyền Thông}
\label{sec:communication_protocols}

Phần này trình bày các giao thức truyền thông cốt lõi cho phép trao đổi dữ liệu và điều khiển trong hệ thống cảnh báo viễn thông nhúng IoT, bao gồm: Giao thức Khởi tạo Phiên (SIP), Message Queuing Telemetry Transport (MQTT), và JavaScript Object Notation (JSON).

\subsection{Giao Thức Khởi Tạo Phiên (SIP)}
\label{subsec:sip_protocol}

SIP là giao thức báo hiệu nền tảng của VoIP, dùng để khởi tạo, quản lý và kết thúc các phiên đa phương tiện qua mạng IP~\cite{sip_rfc3261}. SIP hỗ trợ gọi thoại, hội nghị video, nhắn tin tức thời và thông tin hiện diện. Nó hoạt động ở lớp ứng dụng của mô hình TCP/IP, sử dụng các phương thức dựa trên văn bản tương tự HTTP để đảm bảo tính linh hoạt và dễ mở rộng.

\subsubsection{Kiến Trúc và Luồng Thông Điệp}
\label{subsubsec:sip_architecture}

SIP hoạt động thông qua trao đổi thông điệp giữa \textit{User Agent Clients} (UACs) và \textit{User Agent Servers} (UASs), với sự hỗ trợ của các máy chủ trung gian: \textbf{Proxy Server} (chuyển tiếp tin nhắn), \textbf{Registrar Server} (lưu trữ thông tin đăng ký) và \textbf{Redirect Server} (hướng UAC tới địa chỉ khác). Các thông điệp chính gồm:

\begin{itemize}
\item \textbf{INVITE}: Khởi tạo phiên hoặc cuộc gọi.
\item \textbf{ACK}: Xác nhận phản hồi thành công cho INVITE.
\item \textbf{BYE}: Kết thúc phiên.
\item \textbf{CANCEL}: Hủy yêu cầu đang xử lý.
\item \textbf{REGISTER}: Đăng ký thông tin thiết bị.
\item \textbf{OPTIONS}: Truy vấn khả năng của máy chủ.
\end{itemize}

SIP kết hợp với \textit{Session Description Protocol} (SDP) để định nghĩa tham số phiên (như codec, cổng) và \textit{Real-time Transport Protocol} (RTP) để truyền dữ liệu thoại/video thời gian thực. Ngoài ra, RTCP (RTP Control Protocol) được sử dụng để giám sát chất lượng truyền dẫn.

\subsubsection{SIP trong Hệ Thống Cảnh Báo Asterisk}
\label{subsubsec:sip_asterisk_integration}

Trong hệ thống cảnh báo dựa trên Asterisk, SIP kết nối điện thoại IP, softphone và PBX qua SIP trunk, mang lại lợi ích:

\begin{itemize}
\item \textbf{Quản lý tập trung}: Đồng nhất cấu hình và quản lý thiết bị.
\item \textbf{Tương thích cao}: Hỗ trợ đa dạng nền tảng và thiết bị.
\item \textbf{Chuẩn mở}: Tích hợp dễ dàng với hạ tầng viễn thông hiện có.
\item \textbf{Bảo mật}: Hỗ trợ mã hóa qua \textbf{TLS} (cho kênh SIP) và \textbf{SRTP} (cho luồng RTP) để bảo vệ dữ liệu.
\end{itemize}

Asterisk đóng vai trò như một SIP server, xử lý đăng ký và định tuyến cuộc gọi.

\subsubsection{Luồng Phân Phối Cảnh Báo}
\label{subsubsec:sip_alert_flows}

\paragraph{Đăng ký}
Thiết bị SIP gửi REGISTER tới Asterisk để xác thực và lưu thông tin liên lạc, thường kèm theo thông tin xác thực (username, password) trong header Authorization.

\paragraph{Thiết lập phiên}
Ứng dụng Linux ra lệnh cho Asterisk khởi tạo cuộc gọi qua AMI (lệnh \texttt{Originate}). Asterisk gửi INVITE, nhận phản hồi (180 Ringing, 200 OK) và xác nhận bằng ACK. Có thể dùng header \texttt{Alert-Info: ;info=alert-autoanswer} để tự động trả lời, giúp phân phối cảnh báo nhanh chóng mà không cần tương tác thủ công.

\paragraph{Trao đổi dữ liệu}
Dữ liệu cảnh báo truyền qua RTP. Nếu dùng TTS (Text-to-Speech), Asterisk tạo âm thanh từ văn bản và phát tới người nhận qua các codec như G.711 hoặc G.729.

\paragraph{Kết thúc phiên}
Một bên gửi BYE, bên kia phản hồi 200 OK để đóng phiên an toàn.

\subsubsection{Tích Hợp SMS qua SIP}
\label{subsubsec:sip_sms}

Có thể gửi SMS trong Asterisk bằng cách kích hoạt \texttt{textsupport=yes} trong \texttt{sip.conf} và định nghĩa logic xử lý trong \texttt{extensions.conf}. Ví dụ, sử dụng lệnh \texttt{MessageSend} để gửi tin nhắn SIP MESSAGE, tích hợp với các nhà cung cấp SMS gateway để chuyển tiếp sang mạng di động.

---

\subsection{Giao Thức Message Queuing Telemetry Transport (MQTT)}
\label{subsec:mqtt_protocol}

MQTT là giao thức nhẹ, tối ưu cho truyền thông M2M trong IoT, hoạt động trên TCP/IP với cơ chế kết nối lâu dài~\cite{mqtt_oasis_standard}. Nó được thiết kế cho các thiết bị có tài nguyên hạn chế, băng thông thấp và kết nối không ổn định.

\subsubsection{Kiến Trúc Publish/Subscribe}
\label{subsubsec:mqtt_pubsub}

MQTT dùng mô hình publish/subscribe qua broker trung tâm (như Mosquitto hoặc HiveMQ), mang lại:
\begin{itemize}
\item \textbf{Tách rời không gian}: Không cần biết địa chỉ IP của nhau.
\item \textbf{Tách rời thời gian}: Không yêu cầu kết nối đồng thời, hỗ trợ \textbf{retained messages} (tin nhắn được lưu lại để gửi cho subscriber mới) và \textbf{clean session} (quản lý trạng thái phiên của client).
\item \textbf{Tách rời đồng bộ}: Truyền và nhận độc lập, giảm độ trễ.
\item \textbf{Bảo mật}: Hỗ trợ TLS, xác thực username/password, và ACL để kiểm soát truy cập topic.
\end{itemize}

Các lệnh chính: CONNECT, PUBLISH, SUBSCRIBE, UNSUBSCRIBE, DISCONNECT. Topic sử dụng cấu trúc phân cấp như \texttt{sensor/room/temperature}.

\subsubsection{Mức QoS}
\label{subsubsec:mqtt_qos}

MQTT cung cấp 3 mức QoS để đảm bảo độ tin cậy.

\begin{itemize}
\item \textbf{QoS 0 (At most once)}: Gửi một lần, không xác nhận, phù hợp cho dữ liệu không quan trọng.
\item \textbf{QoS 1 (At least once)}: Gửi ít nhất một lần, có xác nhận (PUBACK), có thể trùng lặp.
\item \textbf{QoS 2 (Exactly once)}: Gửi đúng một lần qua bắt tay bốn bước (PUBREC, PUBREL, PUBCOMP), đảm bảo tin cậy cao.
\end{itemize}

Trong hệ thống IoT, QoS được chọn dựa trên mức độ quan trọng của dữ liệu cảnh báo.

---

\subsection{JavaScript Object Notation (JSON)}
\label{subsec:json_format}

JSON là định dạng dữ liệu nhẹ, dễ đọc, dùng rộng rãi trong IoT và viễn thông để trao đổi dữ liệu có cấu trúc~\cite{json_rfc8259}. Nó dựa trên cú pháp JavaScript nhưng độc lập ngôn ngữ.

\subsubsection{Ứng Dụng JSON}
\label{subsubsec:json_applications}

\begin{itemize}
\item Lưu cấu hình thiết bị và máy chủ.
\item Trao đổi dữ liệu cảm biến, cảnh báo giữa các thành phần hệ thống.
\item Tương thích đa nền tảng, dễ phân tích bằng các thư viện như \textit{json-c} cho C, hoặc \textit{ArduinoJson} cho ESP32.
\item Tối ưu hóa payload cho MQTT và SIP bằng cách giảm độ dài tên khóa và loại bỏ khoảng trắng.
\end{itemize}

\subsubsection{Ví Dụ JSON}
\label{subsubsec:json_examples}

\begin{figure}[H]
\centering
\begin{minted}[frame=single, breaklines, bgcolor=lightgray, xleftmargin=10pt, linenos]{json}
{
  "network": {
    "ssid": "IoT_Network",
    "password": "MatKhauBaoMat123",
    "mqtt_broker": "192.168.1.100",
    "mqtt_port": 1883
  },
  "device": {
    "id": "ESP32_Sensor_01",
    "location": "Tang_May_A"
  }
}
\end{minted}
\caption{Cấu hình ESP32}
\label{fig:json_esp32_config}
\end{figure}

\begin{figure}[H]
\centering
\begin{minted}[frame=single, breaklines, bgcolor=lightgray, xleftmargin=10pt, linenos]{json}
{
  "device_id": "ESP32_Sensor_01",
  "timestamp": "2024-03-15T10:30:00Z",
  "readings": {
    "temperature": {
      "value": 87.5,
      "unit": "celsius",
      "status": "critical"
    }
  }
}
\end{minted}
\caption{Dữ liệu Cảm Biến}
\label{fig:json_sensor_data}
\end{figure}

---

\section{Tổng Hợp Luồng Dữ Liệu và Tích Hợp Hệ Thống}
\label{sec:system_integration}

Phần này mô tả cách các giao thức SIP, MQTT và định dạng JSON phối hợp trong một hệ thống cảnh báo IoT/VoIP toàn diện.

\subsubsection{Cấu hình Asterisk và MQTT để xử lý cảnh báo}
\label{subsubsec:config_asterisk}

\paragraph{Cấu hình MQTT Broker (Mosquitto ACL)}
Để đảm bảo an toàn, cần thiết lập quyền truy cập (ACL) cho các thiết bị IoT.
\begin{minted}[frame=single, breaklines, bgcolor=lightgray, xleftmargin=10pt, linenos]{text}
# file: /etc/mosquitto/acl.conf
user esp32_sensor
topic write home/sensor/data
topic read home/alerts/#
\end{minted}
Với cấu hình này, thiết bị \texttt{esp32\_sensor} chỉ có thể gửi dữ liệu lên topic \texttt{home/sensor/data} và nhận cảnh báo từ các topic dưới \texttt{home/alerts}.

\paragraph{Cấu hình Asterisk (extensions.conf)}
Một ứng dụng bên ngoài (ví dụ, một script Python) sẽ theo dõi tin nhắn MQTT và sử dụng Asterisk Manager Interface (AMI) để khởi tạo cuộc gọi. Dưới đây là logic xử lý cuộc gọi trong \texttt{extensions.conf}.
\begin{minted}[frame=single, breaklines, bgcolor=lightgray, xleftmargin=10pt, linenos]{text}
[mqtt-alert]
exten => s,1,NoOp(Received MQTT Alert)
exten => s,n,Set(ALERT_MSG=${ALERT_INFO})
exten => s,n,Verbose(1, Alert received: ${ALERT_MSG})
exten => s,n,System(/usr/bin/php /var/www/alert_processor.php "${ALERT_MSG}")
exten => s,n,Hangup()
\end{minted}
Trong đó, script \texttt{alert\_processor.php} sẽ nhận thông tin từ AMI và thực hiện các hành động tiếp theo, chẳng hạn như gửi lệnh \texttt{Originate} để gọi tới một số điện thoại.

\subsubsection{Sơ đồ Luồng Dữ liệu}
Luồng dữ liệu được minh họa theo các bước sau:
\begin{enumerate}
    \item \textbf{Thiết bị (ESP32)}: Thiết bị nhúng thu thập dữ liệu cảm biến. Khi một sự kiện cảnh báo (ví dụ: nhiệt độ vượt ngưỡng) xảy ra, nó tạo một payload \textbf{JSON} nhỏ gọn chứa thông tin chi tiết về cảnh báo.
    \item \textbf{MQTT Publish}: Thiết bị sử dụng giao thức \textbf{MQTT} để gửi payload JSON này tới một topic cụ thể trên \textbf{MQTT Broker} (ví dụ: \texttt{alert/sensor/temperature}).
    \item \textbf{MQTT Subscribe}: Một ứng dụng trung gian trên \textbf{Asterisk Server} theo dõi (subscribe) topic này. Khi nhận được tin nhắn, ứng dụng sẽ phân tích payload \textbf{JSON} để trích xuất loại và giá trị cảnh báo.
    \item \textbf{SIP Origination}: Dựa trên thông tin từ payload JSON, ứng dụng này sử dụng \textbf{AMI (Asterisk Manager Interface)} để kích hoạt một cuộc gọi SIP (\texttt{Originate}) tới một số điện thoại đã được cấu hình.
    \item \textbf{SIP Session}: Asterisk gửi \texttt{INVITE} và thiết lập phiên thoại với người nhận. Dữ liệu âm thanh cảnh báo (được tạo từ TTS) được truyền qua \textbf{RTP/SRTP}.
    \item \textbf{Kết thúc}: Sau khi bản tin cảnh báo được phát, phiên SIP kết thúc bằng tin nhắn \texttt{BYE}.
\end{enumerate}

---

\subsubsection{Tối ưu hóa Hiệu suất và Độ tin cậy}
\label{subsec:optimization}

\begin{itemize}
    \item \textbf{Tối ưu hóa Payload}: Giảm kích thước của payload \textbf{JSON} để giảm băng thông và năng lượng tiêu thụ trên thiết bị nhúng.
    \item \textbf{QoS}: Sử dụng QoS 1 hoặc 2 cho các tin nhắn cảnh báo quan trọng trên MQTT để đảm bảo chúng không bị mất. Sử dụng QoS 0 cho các tin nhắn dữ liệu cảm biến thường xuyên để tối ưu hiệu suất.
    \item \textbf{Quản lý kết nối}: Triển khai cơ chế tự động kết nối lại (\textit{reconnect}) cho cả MQTT và SIP trên thiết bị nhúng để xử lý mất kết nối tạm thời.
    \item \textbf{Bảo mật}: Luôn sử dụng \textbf{TLS} cho cả MQTT và SIP để mã hóa dữ liệu. Cấu hình \textbf{ACL} trên MQTT Broker và xác thực người dùng trên SIP Server để ngăn chặn truy cập trái phép.
\end{itemize}
