\section{Các Giao Thức Truyền Thông}
\label{sec:communication_protocols}
Tiếp nối các phân tích về tình hình nghiên cứu hiện có và các khoảng trống công nghệ được xác định trong phần tổng quan và tình hình nghiên cứu. Chương này chuyển trọng tâm sang trình bày chi tiết về các \textbf{cơ sở lý thuyết và giao thức nền tảng} chi phối hoạt động của Hệ thống Cảnh báo Viễn thông Nhúng IoT được đề xuất, đặc biệt trong ứng dụng \textbf{Phát hiện Ngã (Fall Detection)}.

Trong hệ thống cảnh báo thời gian thực, nơi tính kịp thời của thông tin là yếu tố quyết định, khả năng \textbf{giao tiếp không gián đoạn} giữa các thành phần nhúng và trung tâm điều khiển là tối quan trọng. Chương này sẽ hệ thống hóa các giao thức truyền thông cốt lõi. Cụ thể, \textbf{Giao thức Khởi tạo Phiên (SIP)} sẽ được làm rõ như xương sống cho việc truyền tải âm thanh/video cảnh báo theo thời gian thực; \textbf{Message Queuing Telemetry Transport (MQTT)} được phân tích như một giải pháp \textit{lightweight} và hiệu quả để vận chuyển dữ liệu cảm biến (như dữ liệu gia tốc kế, con quay hồi chuyển sau khi xử lý thuật toán phát hiện ngã) trên các mạng bị hạn chế băng thông; và \textbf{JavaScript Object Notation (JSON)} như định dạng chuẩn để cấu trúc và trao đổi thông tin. Việc nắm vững các cơ chế này là nền tảng để xây dựng và đảm bảo hiệu suất của một hệ thống cảnh báo từ xa, tin cậy và có khả năng mở rộng.
\subsection{Giao Thức Khởi Tạo Phiên (SIP)}
\label{subsec:sip_protocol}

SIP là giao thức báo hiệu nền tảng của VoIP, dùng để khởi tạo, quản lý và kết thúc các phiên đa phương tiện qua mạng IP~\cite{sip_rfc3261}. SIP hỗ trợ gọi thoại, hội nghị video, nhắn tin tức thời và thông tin hiện diện. Nó hoạt động ở lớp ứng dụng của mô hình TCP/IP, sử dụng các phương thức dựa trên văn bản tương tự HTTP để đảm bảo tính linh hoạt và dễ mở rộng.

\subsubsection{Kiến Trúc và Luồng Thông Điệp}
\label{subsubsec:sip_architecture}

SIP hoạt động thông qua trao đổi thông điệp giữa \textit{User Agent Clients} (UACs) và \textit{User Agent Servers} (UASs), với sự hỗ trợ của các máy chủ trung gian: \textbf{Proxy Server} (chuyển tiếp tin nhắn), \textbf{Registrar Server} (lưu trữ thông tin đăng ký) và \textbf{Redirect Server} (hướng UAC tới địa chỉ khác). Các thông điệp chính gồm:

\begin{itemize}
\item \textbf{INVITE}: Khởi tạo phiên hoặc cuộc gọi.
\item \textbf{ACK}: Xác nhận phản hồi thành công cho INVITE.
\item \textbf{BYE}: Kết thúc phiên.
\item \textbf{CANCEL}: Hủy yêu cầu đang xử lý.
\item \textbf{REGISTER}: Đăng ký thông tin thiết bị.
\item \textbf{OPTIONS}: Truy vấn khả năng của máy chủ.
\end{itemize}

SIP kết hợp với \textit{Session Description Protocol} (SDP) để định nghĩa tham số phiên (như codec, cổng) và \textit{Real-time Transport Protocol} (RTP) để truyền dữ liệu thoại/video thời gian thực. Ngoài ra, RTCP (RTP Control Protocol) được sử dụng để giám sát chất lượng truyền dẫn.

\subsubsection{Phân biệt Đường tín hiệu và Đường truyền phương tiện}
\label{subsubsec:sip_paths}

Đây là một sự khác biệt quan trọng trong VoIP:

\begin{itemize}
\item \textbf{Đường tín hiệu (Signaling Path):} Mang các tin nhắn SIP (INVITE, BYE, 200 OK, v.v.) để thiết lập, quản lý và kết thúc cuộc gọi. Đường này thường sử dụng TCP (để truyền tải đáng tin cậy, đặc biệt cho các tin nhắn lớn hơn hoặc các kết nối kéo dài) hoặc UDP (để có độ trễ thấp hơn, đặc biệt cho các tin nhắn nhỏ hơn như REGISTER).
\item \textbf{Đường truyền phương tiện (Media Path):} Mang dữ liệu thoại/video thực tế bằng RTP qua UDP. Sau khi cuộc gọi được thiết lập thông qua tín hiệu, phương tiện truyền trực tiếp giữa các điểm cuối (hoặc thông qua một bộ chuyển tiếp phương tiện trung gian như máy chủ TURN hoặc SBC).
\end{itemize}

Dưới đây là sơ đồ minh họa sự khác biệt giữa đường tín hiệu và đường truyền phương tiện:

%-------- figure--------
\begin{figure}[htb!] 
\centering
\begin{tikzpicture}[
    box/.style={rectangle, draw, rounded corners, minimum height=1em, minimum width=3em, align=center, fill=blue!10}, 
    signal_arrow/.style={-Stealth, thick, blue!70!white, shorten >=1pt, shorten <=1pt}, 
    media_arrow/.style={-Stealth, thick, red!70!white, shorten >=1pt, shorten <=1pt}, 
    label_style/.style={font=\small, align=center, text=black},
    node distance=2.5cm and 3.5cm 
]
    % Định nghĩa các Node
    \node[box] (A) {SIP Endpoint A};
    \node[box, right=of A] (Proxy) {SIP Proxy/PBX \\ (Asterisk)}; 
    \node[box, right=of Proxy] (B) {SIP Endpoint B};
    
    % Node cho Media Proxy (nằm dưới Asterisk PBX)
    \node[box, below=2.5cm of Proxy] (MediaProxy) {Asterisk Media Proxy}; 
    
    % Vẽ đường tín hiệu
    \draw[signal_arrow] (A) -- node[above=2pt, label_style] {SIP Signaling \\ (TCP/UDP)} (Proxy);
    \draw[signal_arrow] (Proxy) -- node[above=2pt, label_style] {SIP Signaling \\ (TCP/UDP)} (B);
    
    % Vẽ đường truyền phương tiện
    \draw[media_arrow] (A) -- node[midway, left=2pt, label_style] {RTP Media Path \\ (UDP)} (MediaProxy); 
    \draw[media_arrow] (MediaProxy) -- node[midway, right=2pt, label_style] {RTP Media Path \\ (UDP)} (B); 
\end{tikzpicture}
\caption{Minh họa sự khác biệt giữa đường tín hiệu và đường truyền phương tiện trong VoIP}
\label{fig:sip-media-path-distinction} 
\end{figure}

\subsubsection{Giao thức Thiết lập Kết nối Tương tác (ICE)}
\label{subsubsec:ice_protocol}

Trong môi trường mạng thực tế, các thiết bị thường nằm sau NAT (Network Address Translation) hoặc tường lửa, ngăn cản việc truyền dữ liệu trực tiếp qua RTP. \textbf{ICE} là một khung giao thức (Framework) được sử dụng để giải quyết vấn đề \textbf{NAT Traversal} (xuyên NAT) bằng cách tìm ra đường dẫn tốt nhất giữa hai điểm cuối. ICE sử dụng kết hợp các giao thức sau:

\begin{itemize}
    \item \textbf{Cục bộ (Local IP):} Địa chỉ IP nội bộ của thiết bị.
    \item \textbf{STUN (Session Traversal Utilities for NAT):} Giao thức giúp các thiết bị phát hiện địa chỉ IP công cộng (Public IP) và cổng (Port) mà NAT đã ánh xạ.
    \item \textbf{TURN (Traversal Using Relays around NAT):} Được sử dụng như một giải pháp cuối cùng khi STUN thất bại. TURN đóng vai trò là máy chủ chuyển tiếp (Relay Server), tất cả dữ liệu được gửi qua máy chủ này để tránh tường lửa nghiêm ngặt.
\end{itemize}

Quá trình ICE được thực hiện thông qua SDP (trong thông điệp SIP), nơi các điểm cuối trao đổi thông tin về các địa chỉ IP/cổng (gọi là "ứng cử viên") mà chúng đã thu thập.

\begin{figure}[h]
\centering
\begin{tikzpicture}[
    node distance=2.5cm and 5cm, % Tăng khoảng cách ngang để hình thoáng hơn
    box/.style={rectangle, draw, rounded corners, minimum width=3.5cm, minimum height=1cm, align=center, fill=blue!10},
    text_only/.style={align=left, font=\small, inner sep=0pt}, 
    arrow_style/.style={-Stealth, thick, blue!70!black} 
]

    % Cột Endpoint A
    \node[box] (A_ep) {SIP Endpoint A};
    \node[text_only, below=0.5cm of A_ep.south west, anchor=north west] (A_cand_1) {1) Thu thập ứng cử viên:};
    \node[text_only, below=0.1cm of A_cand_1.south west, anchor=north west] (A_cand_2) {- IP cục bộ: 192.168.1.10};
    \node[text_only, below=0.1cm of A_cand_2.south west, anchor=north west] (A_cand_3) {- IP STUN: 203.0.113.5};
    \node[text_only, below=0.1cm of A_cand_3.south west, anchor=north west] (A_cand_4) {- IP TURN: 192.0.2.10};

    % Cột Endpoint B
    % Đặt B dựa trên A (ngang bằng A_ep)
    \node[box, right=of A_ep] (B_ep) {SIP Endpoint B};
    
    % Đặt văn bản B dựa trên neo của A (để đảm bảo khoảng cách đối xứng)
    \node[text_only] (B_cand_1) at (B_ep.south west |- A_cand_1.west) [anchor=north west] {1) Thu thập ứng cử viên:};
    \node[text_only] (B_cand_2) at (B_ep.south west |- A_cand_2.west) [anchor=north west] {- IP cục bộ: 10.0.0.20};
    \node[text_only] (B_cand_3) at (B_ep.south west |- A_cand_3.west) [anchor=north west] {- IP STUN: 198.51.100.12};
    \node[text_only] (B_cand_4) at (B_ep.south west |- A_cand_4.west) [anchor=north west] {- IP TURN: 192.0.2.20};
    
    % Vị trí Kiểm tra (Đảm bảo đối xứng hoàn toàn)
    \coordinate (CenterMid) at ($(A_cand_4.south)!0.5!(B_cand_4.south)$);
    \node[box, below=2.5cm of CenterMid, text width=8cm] (Check) { 
        3) Thực hiện kiểm tra kết nối \\
        (ví dụ: UDP trực tiếp, STUN, TURN)
    };

    \node[box, below=1cm of Check] (Select) {
        4) Chọn đường dẫn tốt nhất \\
        (ví dụ: UDP trực tiếp nếu có thể)
    };

    % Các đường nối
    % Endpoint A và danh sách ứng cử viên
    \draw[arrow_style] (A_ep.south) -- (A_cand_1.north);
    % Endpoint B và danh sách ứng cử viên (Phải đảm bảo neo đúng)
    \draw[arrow_style] (B_ep.south) -- (B_cand_1.north);

    % Trao đổi ứng cử viên
    \draw[arrow_style, <->] (A_cand_4.east) -- node[above, align=center, font=\small] {2) Trao đổi ứng cử viên \\ qua SIP/SDP} (B_cand_4.west);
    
    % Từ ứng cử viên đến Kiểm tra kết nối
    \draw[arrow_style] (A_cand_4.south) |- (Check.west);
    \draw[arrow_style] (B_cand_4.south) |- (Check.east);
    
    % Từ Kiểm tra kết nối đến Chọn đường dẫn
    \draw[arrow_style] (Check.south) -- (Select.north);

\end{tikzpicture}
\caption{Minh họa Quá trình thu thập ứng cử viên ICE và kiểm tra kết nối}
\label{fig:ice_flow_symmetric}
\end{figure}

Quá trình ICE đảm bảo rằng dữ liệu cảnh báo RTP được truyền một cách tin cậy nhất có thể giữa các thiết bị nhúng và trung tâm điều khiển, ngay cả khi chúng nằm sau các NAT khác nhau, tối ưu hóa độ trễ và độ tin cậy của hệ thống cảnh báo thời gian thực.

\subsubsection{SIP trong Hệ Thống Cảnh Báo Asterisk}
\label{subsubsec:sip_asterisk_integration}

Trong hệ thống cảnh báo dựa trên Asterisk, SIP kết nối điện thoại IP, softphone và PBX qua SIP trunk, mang lại lợi ích:

\begin{itemize}
\item \textbf{Quản lý tập trung}: Đồng nhất cấu hình và quản lý thiết bị.
\item \textbf{Tương thích cao}: Hỗ trợ đa dạng nền tảng và thiết bị.
\item \textbf{Chuẩn mở}: Tích hợp dễ dàng với hạ tầng viễn thông hiện có.
\item \textbf{Bảo mật}: Hỗ trợ mã hóa qua \textbf{TLS} (cho kênh SIP) và \textbf{SRTP} (cho luồng RTP) để bảo vệ dữ liệu.
\end{itemize}

Asterisk đóng vai trò như một SIP server, xử lý đăng ký và định tuyến cuộc gọi.

\subsubsection{Luồng Phân Phối Cảnh Báo}
\label{subsubsec:sip_alert_flows}

\paragraph{Đăng ký}
Thiết bị SIP gửi REGISTER tới Asterisk để xác thực và lưu thông tin liên lạc, thường kèm theo thông tin xác thực (username, password) trong header Authorization.

\paragraph{Thiết lập phiên}
Ứng dụng Linux ra lệnh cho Asterisk khởi tạo cuộc gọi qua AMI (lệnh \texttt{Originate}). Asterisk gửi INVITE, nhận phản hồi (180 Ringing, 200 OK) và xác nhận bằng ACK. Có thể dùng header \texttt{Alert-Info: ;info=alert-autoanswer} để tự động trả lời, giúp phân phối cảnh báo nhanh chóng mà không cần tương tác thủ công.

\paragraph{Trao đổi dữ liệu}
Dữ liệu cảnh báo truyền qua RTP. Nếu dùng TTS (Text-to-Speech), Asterisk tạo âm thanh từ văn bản và phát tới người nhận qua các codec như G.711 hoặc G.729.

\paragraph{Kết thúc phiên}
Một bên gửi BYE, bên kia phản hồi 200 OK để đóng phiên an toàn.

\subsubsection{Tích Hợp SMS qua SIP}
\label{subsubsec:sip_sms}

Có thể gửi SMS trong Asterisk bằng cách kích hoạt \texttt{textsupport=yes} trong \texttt{sip.conf} và định nghĩa logic xử lý trong \texttt{extensions.conf}. Ví dụ, sử dụng lệnh \texttt{MessageSend} để gửi tin nhắn SIP MESSAGE, tích hợp với các nhà cung cấp SMS gateway để chuyển tiếp sang mạng di động.


\subsection{Giao Thức Message Queuing Telemetry Transport (MQTT)}
\label{subsec:mqtt_protocol}
... (Nội dung MQTT tiếp tục như cũ)
\subsection{Giao Thức Message Queuing Telemetry Transport (MQTT)}
\label{subsec:mqtt_protocol}

MQTT là giao thức nhẹ, tối ưu cho truyền thông M2M trong IoT, hoạt động trên TCP/IP với cơ chế kết nối lâu dài~\cite{mqtt_oasis_standard}. Nó được thiết kế cho các thiết bị có tài nguyên hạn chế, băng thông thấp và kết nối không ổn định.

\subsubsection{Kiến Trúc Publish/Subscribe}
\label{subsubsec:mqtt_pubsub}

MQTT dùng mô hình publish/subscribe qua broker trung tâm (như Mosquitto hoặc HiveMQ), mang lại:
\begin{itemize}
\item \textbf{Tách rời không gian}: Không cần biết địa chỉ IP của nhau.
\item \textbf{Tách rời thời gian}: Không yêu cầu kết nối đồng thời, hỗ trợ \textbf{retained messages} (tin nhắn được lưu lại để gửi cho subscriber mới) và \textbf{clean session} (quản lý trạng thái phiên của client).
\item \textbf{Tách rời đồng bộ}: Truyền và nhận độc lập, giảm độ trễ.
\item \textbf{Bảo mật}: Hỗ trợ TLS, xác thực username/password, và ACL để kiểm soát truy cập topic.
\end{itemize}

Các lệnh chính: CONNECT, PUBLISH, SUBSCRIBE, UNSUBSCRIBE, DISCONNECT. Topic sử dụng cấu trúc phân cấp như \texttt{sensor/room/temperature}.

\subsubsection{Mức QoS}
\label{subsubsec:mqtt_qos}

MQTT cung cấp 3 mức QoS để đảm bảo độ tin cậy.

\begin{itemize}
\item \textbf{QoS 0 (At most once)}: Gửi một lần, không xác nhận, phù hợp cho dữ liệu không quan trọng.
\item \textbf{QoS 1 (At least once)}: Gửi ít nhất một lần, có xác nhận (PUBACK), có thể trùng lặp.
\item \textbf{QoS 2 (Exactly once)}: Gửi đúng một lần qua bắt tay bốn bước (PUBREC, PUBREL, PUBCOMP), đảm bảo tin cậy cao.
\end{itemize}

Trong hệ thống IoT, QoS được chọn dựa trên mức độ quan trọng của dữ liệu cảnh báo.

---

\subsection{JavaScript Object Notation (JSON)}
\label{subsec:json_format}

JSON là định dạng dữ liệu nhẹ, dễ đọc, dùng rộng rãi trong IoT và viễn thông để trao đổi dữ liệu có cấu trúc~\cite{json_rfc8259}. Nó dựa trên cú pháp JavaScript nhưng độc lập ngôn ngữ.

\subsubsection{Ứng Dụng JSON}
\label{subsubsec:json_applications}

\begin{itemize}
\item Lưu cấu hình thiết bị và máy chủ.
\item Trao đổi dữ liệu cảm biến, cảnh báo giữa các thành phần hệ thống.
\item Tương thích đa nền tảng, dễ phân tích bằng các thư viện như \textit{json-c} cho C, hoặc \textit{ArduinoJson} cho ESP32.
\item Tối ưu hóa payload cho MQTT và SIP bằng cách giảm độ dài tên khóa và loại bỏ khoảng trắng.
\end{itemize}

\subsubsection{Ví Dụ JSON}
\label{subsubsec:json_examples}

\begin{figure}[H]
\centering
\begin{minted}[frame=single, breaklines, bgcolor=lightgray, xleftmargin=10pt, linenos]{json}
{
  "network": {
    "ssid": "IoT_Network",
    "password": "MatKhauBaoMat123",
    "mqtt_broker": "192.168.1.100",
    "mqtt_port": 1883
  },
  "device": {
    "id": "ESP32_Sensor_01",
    "location": "Tang_May_A"
  }
}
\end{minted}
\caption{Cấu hình ESP32}
\label{fig:json_esp32_config}
\end{figure}

\begin{figure}[H]
\centering
\begin{minted}[frame=single, breaklines, bgcolor=lightgray, xleftmargin=10pt, linenos]{json}
{
  "device_id": "ESP32_Sensor_01",
  "timestamp": "2024-03-15T10:30:00Z",
  "readings": {
    "temperature": {
      "value": 87.5,
      "unit": "celsius",
      "status": "critical"
    }
  }
}
\end{minted}
\caption{Dữ liệu Cảm Biến}
\label{fig:json_sensor_data}
\end{figure}

\subsection{Tổng hợp luồng dữ liệu và tích hợp hệ thống cảnh báo IoT/VoIP}
\label{subsec:system_integration}

Hệ thống cảnh báo kết hợp các giao thức \textbf{SIP}, \textbf{MQTT} và định dạng \textbf{JSON} để tạo ra một cơ chế cảnh báo tự động, đáng tin cậy từ thiết bị nhúng tới cuộc gọi VoIP.

\subsubsection{Cấu hình và xử lý cảnh báo}
\paragraph{MQTT Broker (Mosquitto ACL)}
Để đảm bảo quyền truy cập, thiết bị IoT cần được cấu hình ACL trên MQTT Broker. Ví dụ:
\begin{minted}[frame=single, breaklines, bgcolor=lightgray, xleftmargin=10pt, linenos]{text}
# file: /etc/mosquitto/acl.conf
user esp32_sensor
topic write home/sensor/data
topic read home/alerts/#
\end{minted}
Trong cấu hình này, thiết bị \texttt{esp32\_sensor} chỉ được gửi dữ liệu lên topic \texttt{home/sensor/data} và nhận cảnh báo từ tất cả các topic dưới \texttt{home/alerts}.

\paragraph{Asterisk Server (extensions.conf)}
Ứng dụng trung gian (Python/PHP) theo dõi các topic MQTT và sử dụng \textbf{AMI} để khởi tạo cuộc gọi SIP. Ví dụ logic trong \texttt{extensions.conf}:
\begin{minted}[frame=single, breaklines, bgcolor=lightgray, xleftmargin=10pt, linenos]{text}
[mqtt-alert]
exten => s,1,NoOp(Received MQTT Alert)
exten => s,n,Set(ALERT_MSG=${ALERT_INFO})
exten => s,n,Verbose(1, Alert received: ${ALERT_MSG})
exten => s,n,System(/usr/bin/php /var/www/alert_processor.php "${ALERT_MSG}")
exten => s,n,Hangup()
\end{minted}
Script \texttt{alert\_processor.php} nhận thông tin từ AMI và thực hiện các hành động tiếp theo, ví dụ gửi lệnh \texttt{Originate} để gọi tới số điện thoại.

\subsubsection{Luồng dữ liệu tổng thể}
Các bước xử lý dữ liệu từ thiết bị tới cuộc gọi SIP được tóm tắt như sau:
\begin{enumerate}
    \item \textbf{Thiết bị (ESP32)}: Thu thập dữ liệu cảm biến, phát hiện sự kiện cảnh báo và tạo payload JSON.
    \item \textbf{MQTT Publish}: Gửi payload JSON tới topic cụ thể trên MQTT Broker, ví dụ \texttt{alert/sensor/temperature}.
    \item \textbf{MQTT Subscribe}: Ứng dụng trung gian trên Asterisk Server theo dõi topic, phân tích payload JSON và trích xuất loại, giá trị cảnh báo.
    \item \textbf{SIP Origination}: Ứng dụng sử dụng AMI để kích hoạt cuộc gọi SIP (\texttt{Originate}) tới số điện thoại đã cấu hình.
    \item \textbf{SIP Session}: Asterisk gửi \texttt{INVITE}, thiết lập phiên thoại; dữ liệu âm thanh cảnh báo (TTS) được truyền qua RTP/SRTP.
    \item \textbf{Kết thúc}: Sau khi phát xong bản tin cảnh báo, phiên SIP kết thúc bằng lệnh \texttt{BYE}.
\end{enumerate}

\subsubsection{Tối ưu hóa hiệu suất và độ tin cậy}
\begin{itemize}
    \item \textbf{Payload nhỏ gọn}: Giảm kích thước JSON để tiết kiệm băng thông và năng lượng trên thiết bị nhúng.
    \item \textbf{QoS MQTT}: Sử dụng QoS 1 hoặc 2 cho tin nhắn cảnh báo quan trọng, QoS 0 cho dữ liệu cảm biến thường xuyên.
    \item \textbf{Quản lý kết nối}: Tự động kết nối lại (\textit{reconnect}) cho MQTT và SIP để xử lý mất kết nối tạm thời.
    \item \textbf{Bảo mật}: Sử dụng TLS cho cả MQTT và SIP; cấu hình ACL trên MQTT Broker và xác thực người dùng trên SIP Server.
\end{itemize}
